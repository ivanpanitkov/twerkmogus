<!DOCTYPE html>
<meta charset="UTF-8">
<meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        touch-action: manipulation;
        -webkit-user-select: none;
        user-select: none;
    }

    html,
    body {
        width: 100%;
        height: 100%;
        overflow: hidden;
        -webkit-text-size-adjust: 100%;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
    }

    /* –õ–∏–¥–µ—Ä–±–æ—Ä–¥ —Å–≤–µ—Ä—Ö—É */
    .leaderboard {
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        padding: 15px 20px;
        border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        min-height: 180px;
    }

    .leaderboard-title {
        text-align: center;
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 15px;
        color: #FFD700;
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }

    .top-players {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 20px;
    }

    .player-card {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 12px 15px;
        min-width: 100px;
        text-align: center;
        border: 2px solid transparent;
    }

    .player-card.gold {
        border-color: #FFD700;
        background: rgba(255, 215, 0, 0.1);
    }

    .player-card.silver {
        border-color: #C0C0C0;
        background: rgba(192, 192, 192, 0.1);
    }

    .player-card.bronze {
        border-color: #CD7F32;
        background: rgba(205, 127, 50, 0.1);
    }

    .player-rank {
        font-size: 14px;
        font-weight: bold;
        margin-bottom: 5px;
        opacity: 0.8;
    }

    .player-name {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100px;
    }

    .player-score {
        font-size: 20px;
        font-weight: bold;
        color: #FFD700;
    }

    .current-player {
        text-align: center;
        font-size: 14px;
        opacity: 0.9;
        padding-top: 10px;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
    }

    .current-rank {
        color: #FFD700;
        font-weight: bold;
    }

    /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
    .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        gap: 20px;
    }

    .counter-container {
        text-align: center;
        margin-bottom: 10px;
    }

    .counter-label {
        font-size: 16px;
        opacity: 0.8;
        margin-bottom: 5px;
    }

    .counter {
        font-size: 64px;
        font-weight: bold;
        color: #FFD700;
        text-shadow: 2px 2px 0 #B8860B, 0 0 20px rgba(255, 215, 0, 0.5);
        transition: all 0.1s;
    }

    .counter.pulse {
        transform: scale(1.1);
    }

    /* –ö–ª–∏–∫–∞–µ–º–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ */
    .click-area {
        flex: 1;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        padding-bottom: 30px;
    }

    .click-image {
        width: 320px;
        height: 320px;
        max-width: 80vw;
        max-height: 80vw;
        cursor: pointer;
        border-radius: 25px;
        background: rgba(255, 255, 255, 0.1);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        transition: transform 0.1s;
        object-fit: cover;
        border: 3px solid rgba(255, 255, 255, 0.2);
    }

    .click-image:active {
        transform: scale(0.95);
    }

    /* –°—Ç–∞—Ç—É—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è */
    .save-status {
        position: absolute;
        bottom: 20px;
        left: 0;
        right: 0;
        text-align: center;
        font-size: 12px;
        padding: 5px;
        transition: opacity 0.3s;
    }

    .save-status.saving {
        opacity: 1;
        color: #FFD700;
    }

    .save-status.idle {
        opacity: 0.5;
    }

    /* –í—Å–ø–ª—ã–≤–∞—é—â–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ */
    .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        pointer-events: none;
    }

    .popup-image {
        width: 250px;
        height: 250px;
        opacity: 0;
        transform: scale(0.3);
        transition: all 0.9s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        filter: drop-shadow(0 0 30px rgba(255, 215, 0, 0.8));
        border-radius: 20px;
    }

    .popup-image.show {
        opacity: 1;
        transform: scale(1);
    }

    .popup-image.hide {
        opacity: 0;
        transform: scale(1.5);
    }

    /* –ú—É–ª—å—Ç–∏—Ç–∞—á —ç—Ñ—Ñ–µ–∫—Ç */
    .multitouch-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 500;
    }

    .touch-point {
        position: absolute;
        width: 40px;
        height: 40px;
        background: radial-gradient(circle, rgba(255, 215, 0, 0.6) 0%, rgba(255, 215, 0, 0) 70%);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        animation: touchPulse 0.3s ease-out forwards;
    }

    @keyframes touchPulse {
        0% {
            transform: translate(-50%, -50%) scale(0.5);
            opacity: 1;
        }

        100% {
            transform: translate(-50%, -50%) scale(1.5);
            opacity: 0;
        }
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-height: 700px) {
        .leaderboard {
            min-height: 150px;
            padding: 12px 15px;
        }

        .click-image {
            width: 260px;
            height: 260px;
        }

        .counter {
            font-size: 54px;
        }
    }
</style>

<div class="leaderboard" id="leaderboard">
    <div class="leaderboard-title">üèÜ –¢–û–ü –ò–ì–†–û–ö–û–í</div>

    <div class="top-players" id="topPlayers">
        <div class="player-card gold">
            <div class="player-rank">ü•á 1 –ú–ï–°–¢–û</div>
            <div class="player-name" id="player1Name">‚Äî</div>
            <div class="player-score" id="player1Score">0</div>
        </div>
        <div class="player-card silver">
            <div class="player-rank">ü•à 2 –ú–ï–°–¢–û</div>
            <div class="player-name" id="player2Name">‚Äî</div>
            <div class="player-score" id="player2Score">0</div>
        </div>
        <div class="player-card bronze">
            <div class="player-rank">ü•â 3 –ú–ï–°–¢–û</div>
            <div class="player-name" id="player3Name">‚Äî</div>
            <div class="player-score" id="player3Score">0</div>
        </div>
    </div>

    <div class="current-player" id="currentPlayer">
        <span id="playerPosition">‚Äî</span> –º–µ—Å—Ç–æ ‚Ä¢ <span id="playerScore">0</span> –æ—á–∫–æ–≤
    </div>
</div>

<div class="main-content">
    <div class="counter-container">
        <div class="counter-label">–í–ê–® –°–ß–ï–¢</div>
        <div class="counter" id="counter">0</div>
    </div>

    <div class="click-area">
        <img src="https://ivanpanitkov.github.io/twerkmogus/Data/images/button1-0.png" class="click-image"
            id="clickImage" alt="–ö–ª–∏–∫–Ω–∏ –º–µ–Ω—è!">
    </div>

    <div class="save-status idle" id="saveStatus">
        üíæ –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    </div>
</div>

<!-- –í—Å–ø–ª—ã–≤–∞—é—â–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ -->
<div class="popup-overlay" id="popupOverlay"></div>

<!-- –ú—É–ª—å—Ç–∏—Ç–∞—á –æ–≤–µ—Ä–ª–µ–π -->
<div class="multitouch-overlay" id="multitouchOverlay"></div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // –î–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã
    const user = tg.initDataUnsafe?.user;
    let clickCount = parseInt(localStorage.getItem('clickCount')) || 0;
    let lastSaveCount = 0;
    let lastSaveTime = Date.now();
    let isSaving = false;

    // –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ—Ç–µ–Ω
    let lastHundred = Math.floor(clickCount / 100);

    const images = [
        'https://ivanpanitkov.github.io/twerkmogus/Data/images/button1-0.png',
        'https://ivanpanitkov.github.io/twerkmogus/Data/images/button1-1.png',
        'https://ivanpanitkov.github.io/twerkmogus/Data/images/button1-2.png',
        'https://ivanpanitkov.github.io/twerkmogus/Data/images/button1-3.png',
        'https://ivanpanitkov.github.io/twerkmogus/Data/images/button1-4.png',
        'https://ivanpanitkov.github.io/twerkmogus/Data/images/button1-5.png',
        'https://ivanpanitkov.github.io/twerkmogus/Data/images/button1-6.png'
    ];

    let currentImageIndex = 0;

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const counterEl = document.getElementById('counter');
    const clickImage = document.getElementById('clickImage');
    const saveStatusEl = document.getElementById('saveStatus');
    const popupOverlay = document.getElementById('popupOverlay');

    // –õ–∏–¥–µ—Ä–±–æ—Ä–¥ —ç–ª–µ–º–µ–Ω—Ç—ã
    const player1Name = document.getElementById('player1Name');
    const player1Score = document.getElementById('player1Score');
    const player2Name = document.getElementById('player2Name');
    const player2Score = document.getElementById('player2Score');
    const player3Name = document.getElementById('player3Name');
    const player3Score = document.getElementById('player3Score');
    const playerPositionEl = document.getElementById('playerPosition');
    const playerScoreEl = document.getElementById('playerScore');

    const multitouchOverlay = document.getElementById('multitouchOverlay');

    // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É
    function showPopup() {
        const popupImg = document.createElement('img');
        popupImg.src = 'https://ivanpanitkov.github.io/twerkmogus/Data/images/popup1.png';
        popupImg.className = 'popup-image';
        popupOverlay.innerHTML = '';
        popupOverlay.appendChild(popupImg);

        requestAnimationFrame(() => {
            popupImg.classList.add('show');
            setTimeout(() => {
                popupImg.classList.remove('show');
                popupImg.classList.add('hide');
                setTimeout(() => {
                    popupOverlay.innerHTML = '';
                }, 600);
            }, 500);
        });

        // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –ø–æ–∫–∞–∑–µ
        if (tg.HapticFeedback) {
            tg.HapticFeedback.notificationOccurred('success');
        }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–∞–∂–¥—É—é —Å–æ—Ç–Ω—é
    function checkHundreds() {
        const currentHundred = Math.floor(clickCount / 100);
        if (currentHundred > lastHundred) {
            showPopup();
            lastHundred = currentHundred;
        }
    }

    // –õ–æ–∫–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞ (–±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞ –∫ –±–æ—Ç—É)
    function updateLocalLeaderboard() {
        const userName = user?.first_name || '–í—ã';
        const userScore = clickCount;

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –∏–≥—Ä–æ–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        playerScoreEl.textContent = userScore;

        // –õ–æ–∫–∞–ª—å–Ω–∞—è —Å–∏–º—É–ª—è—Ü–∏—è –ø–æ–∑–∏—Ü–∏–∏
        if (userScore > 0) {
            const estimatedPosition = Math.max(1, Math.floor(1000 / userScore));
            playerPositionEl.textContent = estimatedPosition;

            // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –≤ —Ç–æ–ø–µ, –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ø
            if (estimatedPosition <= 3) {
                const rank = estimatedPosition;
                if (rank === 1) {
                    player1Name.textContent = userName;
                    player1Score.textContent = userScore;
                } else if (rank === 2) {
                    player2Name.textContent = userName;
                    player2Score.textContent = userScore;
                } else if (rank === 3) {
                    player3Name.textContent = userName;
                    player3Score.textContent = userScore;
                }
            }
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞ –∏–∑ –±–æ—Ç–∞
    function loadRealLeaderboard() {
        const data = {
            action: 'get_leaderboard',
            user_id: user?.id,
            current_score: clickCount
        };

        tg.sendData(JSON.stringify(data));
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    function init() {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        counterEl.textContent = clickCount;
        clickImage.src = images[0];
        playerScoreEl.textContent = clickCount;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—á–µ—Ç—á–∏–∫ —Å–æ—Ç–µ–Ω
        lastHundred = Math.floor(clickCount / 100);

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π –ª–∏–¥–µ—Ä–±–æ—Ä–¥
        loadRealLeaderboard();

        // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ Telegram
        tg.MainButton.hide();

        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–∏–¥–µ—Ä–±–æ—Ä–¥ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
        setInterval(loadRealLeaderboard, 10000);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ª–∏–¥–µ—Ä–±–æ—Ä–¥
        updateLocalLeaderboard();
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–∞
    function updateCounter() {
        counterEl.textContent = clickCount;

        // –ü—Ä–æ—Å—Ç–∞—è –∞–Ω–∏–º–∞—Ü–∏—è
        counterEl.classList.add('pulse');
        setTimeout(() => {
            counterEl.classList.remove('pulse');
        }, 100);

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
        localStorage.setItem('clickCount', clickCount);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –∫–∞–∂–¥—É—é —Å–æ—Ç–Ω—é
        checkHundreds();

        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–∏–¥–µ—Ä–±–æ—Ä–¥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        updateLocalLeaderboard();
    }

    // –≠—Ñ—Ñ–µ–∫—Ç –º—É–ª—å—Ç–∏—Ç–∞—á–∞
    function showTouchEffect(x, y) {
        const touchPoint = document.createElement('div');
        touchPoint.className = 'touch-point';
        touchPoint.style.left = `${x}px`;
        touchPoint.style.top = `${y}px`;

        multitouchOverlay.appendChild(touchPoint);

        setTimeout(() => {
            touchPoint.remove();
        }, 300);
    }

    // –ë—ã—Å—Ç—Ä–æ–µ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (–±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)
    function quickAutoSave() {
        if (isSaving || clickCount === lastSaveCount) return;

        isSaving = true;
        saveStatusEl.className = 'save-status saving';

        const data = {
            action: 'save_score',
            score: clickCount,
            user_id: user?.id,
            username: user?.username,
            first_name: user?.first_name,
            quick_save: true
        };

        tg.sendData(JSON.stringify(data));
        lastSaveCount = clickCount;
        lastSaveTime = Date.now();

        // –ß–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        setTimeout(() => {
            saveStatusEl.className = 'save-status idle';
            isSaving = false;
        }, 1000);
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤
    function handleClick(isMultiTouch = false, touchCount = 1) {
        clickCount += touchCount;

        // –ú–µ–Ω—è–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É
        for (let i = 0; i < touchCount; i++) {
            currentImageIndex = (currentImageIndex + 1) % images.length;
        }
        clickImage.src = images[currentImageIndex];

        // –ê–Ω–∏–º–∞—Ü–∏—è
        clickImage.style.transform = 'scale(0.95)';
        setTimeout(() => {
            clickImage.style.transform = 'scale(1)';
        }, 100);

        // –í–∏–±—Ä–∞—Ü–∏—è
        if (tg.HapticFeedback) {
            const intensity = isMultiTouch ? 'medium' : 'light';
            tg.HapticFeedback.impactOccurred(intensity);
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç
        updateCounter();

        // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 20 –æ—á–∫–æ–≤
        if (clickCount - lastSaveCount >= 20) {
            quickAutoSave();
        }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–∞—á-—Å–æ–±—ã—Ç–∏–π
    clickImage.addEventListener('touchstart', function (e) {
        e.preventDefault();

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞—Å–∞–Ω–∏—è
        Array.from(e.touches).forEach(touch => {
            showTouchEffect(touch.clientX, touch.clientY);
        });

        handleClick(e.touches.length > 1, e.touches.length);
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –º—ã—à—å—é
    clickImage.addEventListener('click', function (e) {
        if (e.touches) return;

        showTouchEffect(e.clientX, e.clientY);
        handleClick(false, 1);
    });

    // ========== –°–û–•–†–ê–ù–ï–ù–ò–ï –ü–†–ò –í–´–•–û–î–ï ==========

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
    function saveOnExit() {
        if (clickCount > lastSaveCount && !isSaving) {
            const data = {
                action: 'save_score',
                score: clickCount,
                user_id: user?.id,
                exit_save: true
            };

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º Beacon API –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
            if (navigator.sendBeacon) {
                const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                navigator.sendBeacon('tg-webapp', blob);
            } else {
                tg.sendData(JSON.stringify(data));
            }
        }
    }

    document.addEventListener('visibilitychange', function () {
        if (document.hidden) {
            saveOnExit();
        }
    });

    tg.onEvent('viewportChanged', function (e) {
        if (!e.isStateStable) {
            saveOnExit();
        }
    });

    window.addEventListener('beforeunload', saveOnExit);
    tg.onEvent('close', saveOnExit);

    // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (–∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ –µ—Å–ª–∏ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è)
    setInterval(() => {
        if (clickCount > lastSaveCount && Date.now() - lastSaveTime > 30000) {
            quickAutoSave();
        }
    }, 10000);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    init();
</script>