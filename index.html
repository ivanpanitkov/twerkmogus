<!DOCTYPE html>
<meta charset="UTF-8">
<meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        touch-action: manipulation;
        -webkit-user-select: none;
        user-select: none;
    }

    html,
    body {
        width: 100%;
        height: 100%;
        overflow: hidden;
        -webkit-text-size-adjust: 100%;
        font-family: -apple-system, BlinkMacgramBotAPI, 'Segoe UI', Roboto, sans-serif;
    }

    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
        padding: 20px;
    }

    .container {
        text-align: center;
        width: 100%;
        max-width: 400px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        position: relative;
        z-index: 1;
    }

    .counter {
        font-size: 72px;
        font-weight: bold;
        color: #FFD700;
        text-shadow: 3px 3px 0 #B8860B;
        margin-bottom: 30px;
        transition: transform 0.3s, color 0.3s, text-shadow 0.3s;
    }

    .counter.pulse {
        transform: scale(1.2);
        color: #ff9900;
        text-shadow: 0 0 20px #ff9900;
        transition: transform 0.3s, color 0.3s;
    }

    .image-container {
        margin: 0 0 30px 0;
    }

    .click-image {
        width: 60vw;
        max-width: 280px;
        height: auto;
        aspect-ratio: 1/1;
        cursor: pointer;
        transition: transform 0.1s;
        display: block;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.1);
    }

    .click-image:active {
        transform: scale(0.95);
    }

    .button {
        background: linear-gradient(45deg, #FF416C, #FF4B2B);
        color: white;
        border: none;
        padding: 18px;
        border-radius: 50px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        width: 100%;
        transition: opacity 0.3s;
        -webkit-tap-highlight-color: transparent;
    }

    .button:active {
        opacity: 0.8;
    }

    .stats {
        background: rgba(255, 255, 255, 0.15);
        border-radius: 10px;
        padding: 15px;
        margin-top: 20px;
        text-align: left;
        font-size: 14px;
    }

    .no-select {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—Å–ø–ª—ã–≤–∞—é—â–µ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏ */
    .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        pointer-events: none;
    }

    .popup-image {
        width: 250px;
        height: 250px;
        opacity: 0;
        transform: scale(0.3);
        transition: all 0.9s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        filter: drop-shadow(0 0 20px rgba(255, 255, 0, 0.8));
    }

    .popup-image.show {
        opacity: 1;
        transform: scale(1);
    }

    .popup-image.hide {
        opacity: 0;
        transform: scale(1.5);
    }
</style>

<div class="container no-select">
    <div class="counter" id="counter">0</div>

    <div class="image-container">
        <img src="https://ivanpanitkov.github.io/twerkmogus/Data/images/button1-0.png" class="click-image"
            id="clickImage" alt="–ö–ª–∏–∫–Ω–∏!">
    </div>

    <button class="button" id="resetBtn">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</button>

    <div class="stats">
        <div>üë§ –ò–≥—Ä–æ–∫: <span id="userName">–ì–æ—Å—Ç—å</span></div>
        <div>üèÜ –†–µ–∫–æ—Ä–¥: <span id="highScore">0</span></div>
    </div>
</div>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—Å–ø–ª—ã–≤–∞—é—â–∏—Ö –∫–∞—Ä—Ç–∏–Ω–æ–∫ -->
<div class="popup-overlay" id="popupOverlay"></div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const user = tg.initDataUnsafe?.user;
    let clickCount = 0;
    let highScore = localStorage.getItem('highScore') || 0;

    const images = [
        'https://ivanpanitkov.github.io/twerkmogus/Data/images/button1-0.png',
        'https://ivanpanitkov.github.io/twerkmogus/Data/images/button1-1.png',
        'https://ivanpanitkov.github.io/twerkmogus/Data/images/button1-2.png',
        'https://ivanpanitkov.github.io/twerkmogus/Data/images/button1-3.png',
        'https://ivanpanitkov.github.io/twerkmogus/Data/images/button1-4.png',
        'https://ivanpanitkov.github.io/twerkmogus/Data/images/button1-5.png',
        'https://ivanpanitkov.github.io/twerkmogus/Data/images/button1-6.png'
    ];

    const popupImageUrl = 'https://ivanpanitkov.github.io/twerkmogus/Data/images/popup1.png';

    let currentImageIndex = 0;

    const counterEl = document.getElementById('counter');
    const clickImage = document.getElementById('clickImage');
    const resetBtn = document.getElementById('resetBtn');
    const userNameEl = document.getElementById('userName');
    const highScoreEl = document.getElementById('highScore');
    const popupOverlay = document.getElementById('popupOverlay');

    function init() {
        if (user) {
            userNameEl.textContent = user.first_name || '–ê–Ω–æ–Ω–∏–º';
        }

        highScoreEl.textContent = highScore;

        const savedCount = localStorage.getItem('clickCount');
        if (savedCount) {
            clickCount = parseInt(savedCount);
            updateCounter();
        }

        clickImage.src = images[0];
    }

    function showPopup() {
        // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –∫–∞—Ä—Ç–∏–Ω–∫–∏
        const popupImg = document.createElement('img');
        popupImg.src = popupImageUrl;
        popupImg.className = 'popup-image';

        // –î–æ–±–∞–≤–ª—è–µ–º –≤ overlay
        popupOverlay.innerHTML = '';
        popupOverlay.appendChild(popupImg);

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—è–≤–ª–µ–Ω–∏—è
        requestAnimationFrame(() => {
            popupImg.classList.add('show');

            // –ß–µ—Ä–µ–∑ 400ms –Ω–∞—á–∏–Ω–∞–µ–º –∏—Å—á–µ–∑–∞—Ç—å
            setTimeout(() => {
                popupImg.classList.remove('show');
                popupImg.classList.add('hide');

                // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 600ms
                setTimeout(() => {
                    popupOverlay.innerHTML = '';
                }, 600);
            }, 400);
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –±–æ–Ω—É—Å–∞ –∑–∞ –º—É–ª—å—Ç–∏—Ç–∞—á
    function showFingerBonus(fingerCount) {
        const bonusEl = document.createElement('div');
        bonusEl.textContent = `üëÜ√ó${fingerCount}!`;
        bonusEl.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 0 0 20px #FF0000;
            z-index: 1000;
            pointer-events: none;
            animation: pop 0.5s ease-out forwards;
        `;
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª—å –∞–Ω–∏–º–∞—Ü–∏–∏
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pop {
                0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
                50% { transform: translate(-50%, -50%) scale(1.3); opacity: 1; }
                100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        document.body.appendChild(bonusEl);
        setTimeout(() => {
            bonusEl.remove();
            style.remove();
        }, 500);
    }

    function updateCounter() {
        counterEl.textContent = clickCount;

        if (clickCount > highScore) {
            highScore = clickCount;
            highScoreEl.textContent = highScore;
            localStorage.setItem('highScore', highScore);
        }

        localStorage.setItem('clickCount', clickCount);

        // –ê–Ω–∏–º–∞—Ü–∏—è –Ω–∞ –∫–∞–∂–¥—ã–µ 10 –∫–ª–∏–∫–æ–≤
        if (clickCount % 10 === 0 && clickCount > 0) {
            counterEl.classList.add('pulse');
            setTimeout(() => {
                counterEl.classList.remove('pulse');
            }, 300);
        }

        // –í—Å–ø–ª—ã–≤–∞—é—â–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–∞ –∫–∞–∂–¥—ã–µ 100 –∫–ª–∏–∫–æ–≤
        if (clickCount % 100 === 0 && clickCount > 0) {
            showPopup();
        }
    }

    // –û–ë–†–ê–ë–û–¢–ß–ò–ö –° –ú–£–õ–¨–¢–ò–¢–ê–ß–ï–ú
    clickImage.addEventListener('touchstart', function(e) {
        // –ë–∞–∑–æ–≤—ã–π –∫–ª–∏–∫ + –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏
        clickCount++;
        currentImageIndex = (currentImageIndex + 1) % images.length;
        clickImage.src = images[currentImageIndex];
        
        // –ï—Å–ª–∏ –º—É–ª—å—Ç–∏—Ç–∞—á (–±–æ–ª—å—à–µ –æ–¥–Ω–æ–≥–æ –ø–∞–ª—å—Ü–∞)
        if (e.touches.length > 1) {
            // –î–æ–±–∞–≤–ª—è–µ–º –æ—á–∫–∏ –∑–∞ –∫–∞–∂–¥—ã–π –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞–ª–µ—Ü
            const extraFingers = e.touches.length - 1;
            clickCount += extraFingers * 5; // +5 –æ—á–∫–æ–≤ –∑–∞ –∫–∞–∂–¥—ã–π –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞–ª–µ—Ü
            
            // –ú–µ–Ω—è–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∑–∞ –∫–∞–∂–¥—ã–π –ø–∞–ª–µ—Ü
            for (let i = 0; i < extraFingers; i++) {
                currentImageIndex = (currentImageIndex + 1) % images.length;
                clickImage.src = images[currentImageIndex];
            }
            
            // –≠—Ñ—Ñ–µ–∫—Ç –º—É–ª—å—Ç–∏—Ç–∞—á–∞
            this.style.transform = `scale(0.9) rotate(${extraFingers * 10}deg)`;
            this.style.filter = `brightness(${1 + extraFingers * 0.2})`;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–æ–Ω—É—Å
            showFingerBonus(extraFingers + 1);
            
            // –°–∏–ª—å–Ω–∞—è –≤–∏–±—Ä–∞—Ü–∏—è
            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('heavy');
            }
        } else {
            // –û–±—ã—á–Ω—ã–π –∫–ª–∏–∫
            this.style.transform = 'scale(0.95)';
            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—é
        updateCounter();
        setTimeout(() => {
            this.style.transform = 'scale(1) rotate(0deg)';
            this.style.filter = 'brightness(1)';
        }, 100);
    });

    // –¢–∞–∫–∂–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –∫–ª–∏–∫–æ–≤ (–º—ã—à—å)
    clickImage.addEventListener('click', function(e) {
        // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ç–∞—á-—Å–æ–±—ã—Ç–∏–µ (–º—ã—à—å –∏–ª–∏ –æ–¥–∏–Ω–æ—á–Ω—ã–π –∫–ª–∏–∫ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ)
        if (!e.touches) {
            clickCount++;
            currentImageIndex = (currentImageIndex + 1) % images.length;
            clickImage.src = images[currentImageIndex];
            
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.style.transform = 'scale(1)';
            }, 100);
            
            updateCounter();
            
            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
        }
    });

    resetBtn.addEventListener('click', function () {
        if (confirm('–¢–æ—á–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å —Å—á–µ—Ç?')) {
            clickCount = 0;
            currentImageIndex = 0;
            clickImage.src = images[0];
            updateCounter();

            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('medium');
            }
        }
    });

    tg.MainButton.setText(`üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å: ${clickCount}`);
    tg.MainButton.show();
    tg.MainButton.onClick(function () {
        const data = {
            action: 'save_score',
            score: clickCount,
            user_id: user?.id
        };
        tg.sendData(JSON.stringify(data));
        tg.close();
    });

    setInterval(function () {
        tg.MainButton.setText(`üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å: ${clickCount}`);
    }, 1000);

    init();
</script>