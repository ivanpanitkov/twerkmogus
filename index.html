<!DOCTYPE html>
<meta charset="UTF-8">
<meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        touch-action: manipulation;
        -webkit-user-select: none;
        user-select: none;
    }

    html,
    body {
        width: 100%;
        height: 100%;
        overflow: hidden;
        -webkit-text-size-adjust: 100%;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
    }

    /* –õ–∏–¥–µ—Ä–±–æ—Ä–¥ —Å–≤–µ—Ä—Ö—É */
    .leaderboard {
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        padding: 15px 20px;
        border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        min-height: 180px;
    }

    .leaderboard-title {
        text-align: center;
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 15px;
        color: #FFD700;
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }

    .top-players {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 20px;
    }

    .player-card {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 12px 15px;
        min-width: 100px;
        text-align: center;
        border: 2px solid transparent;
    }

    .player-card.gold {
        border-color: #FFD700;
        background: rgba(255, 215, 0, 0.1);
    }

    .player-card.silver {
        border-color: #C0C0C0;
        background: rgba(192, 192, 192, 0.1);
    }

    .player-card.bronze {
        border-color: #CD7F32;
        background: rgba(205, 127, 50, 0.1);
    }

    .player-rank {
        font-size: 14px;
        font-weight: bold;
        margin-bottom: 5px;
        opacity: 0.8;
    }

    .player-name {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100px;
    }

    .player-score {
        font-size: 20px;
        font-weight: bold;
        color: #FFD700;
    }

    .current-player {
        text-align: center;
        font-size: 14px;
        opacity: 0.9;
        padding-top: 10px;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
    }

    .current-rank {
        color: #FFD700;
        font-weight: bold;
    }

    /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
    .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        gap: 20px;
    }

    .counter-container {
        text-align: center;
        margin-bottom: 10px;
    }

    .counter-label {
        font-size: 16px;
        opacity: 0.8;
        margin-bottom: 5px;
    }

    .counter {
        font-size: 64px;
        font-weight: bold;
        color: #FFD700;
        text-shadow: 2px 2px 0 #B8860B, 0 0 20px rgba(255, 215, 0, 0.5);
        transition: all 0.1s;
    }

    .counter.pulse {
        transform: scale(1.1);
    }

    /* –ö–ª–∏–∫–∞–µ–º–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ */
    .click-area {
        flex: 1;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        padding-bottom: 30px;
    }

    .click-image {
        width: 320px;
        height: 320px;
        max-width: 80vw;
        max-height: 80vw;
        cursor: pointer;
        background: rgba(255, 255, 255, 0.1);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        transition: transform 0.1s;
        object-fit: cover;
        border: 3px solid rgba(255, 255, 255, 0.2);
    }

    .click-image:active {
        transform: scale(0.95);
    }

    /* –°—Ç–∞—Ç—É—Å */
    .status {
        position: absolute;
        bottom: 20px;
        left: 0;
        right: 0;
        text-align: center;
        font-size: 12px;
        padding: 5px;
        opacity: 0.7;
    }

    /* –í—Å–ø–ª—ã–≤–∞—é—â–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ */
    .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        pointer-events: none;
    }

    .popup-image {
        width: 250px;
        height: 250px;
        opacity: 0;
        transform: scale(0.3);
        transition: all 0.9s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        filter: drop-shadow(0 0 30px rgba(255, 215, 0, 0.8));
        border-radius: 20px;
    }

    .popup-image.show {
        opacity: 1;
        transform: scale(1);
    }

    .popup-image.hide {
        opacity: 0;
        transform: scale(1.5);
    }

    /* –ú—É–ª—å—Ç–∏—Ç–∞—á —ç—Ñ—Ñ–µ–∫—Ç */
    .multitouch-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 500;
    }

    .touch-point {
        position: absolute;
        width: 40px;
        height: 40px;
        background: radial-gradient(circle, rgba(255,215,0,0.6) 0%, rgba(255,215,0,0) 70%);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        animation: touchPulse 0.3s ease-out forwards;
    }

    @keyframes touchPulse {
        0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
        100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-height: 700px) {
        .leaderboard {
            min-height: 150px;
            padding: 12px 15px;
        }
        
        .click-image {
            width: 260px;
            height: 260px;
        }
        
        .counter {
            font-size: 54px;
        }
    }
</style>

<div class="leaderboard" id="leaderboard">
    <div class="leaderboard-title">üèÜ –¢–û–ü –ò–ì–†–û–ö–û–í</div>
    
    <div class="top-players" id="topPlayers">
        <div class="player-card gold">
            <div class="player-rank">ü•á 1 –ú–ï–°–¢–û</div>
            <div class="player-name" id="player1Name">‚Äî</div>
            <div class="player-score" id="player1Score">0</div>
        </div>
        <div class="player-card silver">
            <div class="player-rank">ü•à 2 –ú–ï–°–¢–û</div>
            <div class="player-name" id="player2Name">‚Äî</div>
            <div class="player-score" id="player2Score">0</div>
        </div>
        <div class="player-card bronze">
            <div class="player-rank">ü•â 3 –ú–ï–°–¢–û</div>
            <div class="player-name" id="player3Name">‚Äî</div>
            <div class="player-score" id="player3Score">0</div>
        </div>
    </div>
    
    <div class="current-player" id="currentPlayer">
        <span id="playerPosition">‚Äî</span> –º–µ—Å—Ç–æ ‚Ä¢ <span id="playerScore">0</span> –æ—á–∫–æ–≤
    </div>
</div>

<div class="main-content">
    <div class="counter-container">
        <div class="counter-label">–í–ê–® –°–ß–ï–¢</div>
        <div class="counter" id="counter">0</div>
    </div>
    
    <div class="click-area">
        <img src="https://ivanpanitkov.github.io/twerkmogus/Data/images/button1-0.png" 
             class="click-image" 
             id="clickImage" 
             alt="–ö–ª–∏–∫–Ω–∏ –º–µ–Ω—è!">
    </div>
    
    <div class="status" id="status">
        üü¢ –û–Ω–ª–∞–π–Ω
    </div>
</div>

<!-- –í—Å–ø–ª—ã–≤–∞—é—â–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ -->
<div class="popup-overlay" id="popupOverlay"></div>

<!-- –ú—É–ª—å—Ç–∏—Ç–∞—á –æ–≤–µ—Ä–ª–µ–π -->
<div class="multitouch-overlay" id="multitouchOverlay"></div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // –î–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã
    const user = tg.initDataUnsafe?.user;
    let currentScore = 0;
    let bestScore = 0;
    let totalClicks = 0;
    let isSending = false;
    let lastHundred = 0;

    const images = [
        'https://ivanpanitkov.github.io/twerkmogus/Data/images/button1-0.png',
        'https://ivanpanitkov.github.io/twerkmogus/Data/images/button1-1.png',
        'https://ivanpanitkov.github.io/twerkmogus/Data/images/button1-2.png',
        'https://ivanpanitkov.github.io/twerkmogus/Data/images/button1-3.png',
        'https://ivanpanitkov.github.io/twerkmogus/Data/images/button1-4.png',
        'https://ivanpanitkov.github.io/twerkmogus/Data/images/button1-5.png',
        'https://ivanpanitkov.github.io/twerkmogus/Data/images/button1-6.png'
    ];

    let currentImageIndex = 0;

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const counterEl = document.getElementById('counter');
    const clickImage = document.getElementById('clickImage');
    const statusEl = document.getElementById('status');
    const popupOverlay = document.getElementById('popupOverlay');
    
    // –õ–∏–¥–µ—Ä–±–æ—Ä–¥ —ç–ª–µ–º–µ–Ω—Ç—ã
    const player1Name = document.getElementById('player1Name');
    const player1Score = document.getElementById('player1Score');
    const player2Name = document.getElementById('player2Name');
    const player2Score = document.getElementById('player2Score');
    const player3Name = document.getElementById('player3Name');
    const player3Score = document.getElementById('player3Score');
    const playerPositionEl = document.getElementById('playerPosition');
    const playerScoreEl = document.getElementById('playerScore');
    
    const multitouchOverlay = document.getElementById('multitouchOverlay');

    // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É
    function showPopup() {
        const popupImg = document.createElement('img');
        popupImg.src = 'https://ivanpanitkov.github.io/twerkmogus/Data/images/popup1.png';
        popupImg.className = 'popup-image';
        popupOverlay.innerHTML = '';
        popupOverlay.appendChild(popupImg);

        requestAnimationFrame(() => {
            popupImg.classList.add('show');
            setTimeout(() => {
                popupImg.classList.remove('show');
                popupImg.classList.add('hide');
                setTimeout(() => {
                    popupOverlay.innerHTML = '';
                }, 600);
            }, 500);
        });
        
        // –í–∏–±—Ä–∞—Ü–∏—è
        if (tg.HapticFeedback) {
            tg.HapticFeedback.notificationOccurred('success');
        }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–∞–∂–¥—É—é —Å–æ—Ç–Ω—é
    function checkHundreds() {
        const currentHundred = Math.floor(currentScore / 100);
        if (currentHundred > lastHundred) {
            showPopup();
            lastHundred = currentHundred;
        }
    }

    // –≠—Ñ—Ñ–µ–∫—Ç –º—É–ª—å—Ç–∏—Ç–∞—á–∞
    function showTouchEffect(x, y) {
        const touchPoint = document.createElement('div');
        touchPoint.className = 'touch-point';
        touchPoint.style.left = `${x}px`;
        touchPoint.style.top = `${y}px`;
        
        multitouchOverlay.appendChild(touchPoint);
        
        setTimeout(() => {
            touchPoint.remove();
        }, 300);
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–ª–∏–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    function sendClickToServer(clicks = 1) {
        if (isSending) return;
        
        isSending = true;
        
        const data = {
            action: 'add_clicks',
            clicks: clicks,
            user_id: user?.id,
            timestamp: Date.now()
        };
        
        console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–ª–∏–∫–∞:', data);
        
        tg.sendData(JSON.stringify(data));
        
        // –í—Ä–µ–º–µ–Ω–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç –¥–ª—è –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç–∏
        currentScore += clicks;
        updateUI();
        
        setTimeout(() => {
            isSending = false;
        }, 50);
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
    function updateUI() {
        counterEl.textContent = currentScore;
        playerScoreEl.textContent = currentScore;
        
        // –ê–Ω–∏–º–∞—Ü–∏—è
        counterEl.classList.add('pulse');
        setTimeout(() => {
            counterEl.classList.remove('pulse');
        }, 100);
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–æ—Ç–Ω–∏
        checkHundreds();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª—É—á—à–∏–π —Å—á–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ
        if (currentScore > bestScore) {
            bestScore = currentScore;
        }
    }

    // –ó–∞–ø—Ä–æ—Å —Å—á–µ—Ç–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞
    function getScoreFromServer() {
        const data = {
            action: 'get_score',
            user_id: user?.id
        };
        
        tg.sendData(JSON.stringify(data));
        statusEl.textContent = 'üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
    }

    // –ó–∞–ø—Ä–æ—Å –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞
    function getLeaderboardFromServer() {
        const data = {
            action: 'get_leaderboard',
            user_id: user?.id
        };
        
        tg.sendData(JSON.stringify(data));
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤
    function handleClick(isMultiTouch = false, touchCount = 1) {
        // –ê–Ω–∏–º–∞—Ü–∏—è
        clickImage.style.transform = 'scale(0.95)';
        
        // –ú–µ–Ω—è–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É
        currentImageIndex = (currentImageIndex + 1) % images.length;
        clickImage.src = images[currentImageIndex];
        
        // –≠—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞—Å–∞–Ω–∏—è
        if (isMultiTouch && touchCount > 1) {
            for (let i = 1; i < touchCount; i++) {
                currentImageIndex = (currentImageIndex + 1) % images.length;
            }
            clickImage.src = images[currentImageIndex];
        }
        
        setTimeout(() => {
            clickImage.style.transform = 'scale(1)';
        }, 100);
        
        // –í–∏–±—Ä–∞—Ü–∏—è
        if (tg.HapticFeedback) {
            const intensity = isMultiTouch ? 'medium' : 'light';
            tg.HapticFeedback.impactOccurred(intensity);
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        sendClickToServer(touchCount);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–∞—á-—Å–æ–±—ã—Ç–∏–π
    clickImage.addEventListener('touchstart', function(e) {
        e.preventDefault();
        
        Array.from(e.touches).forEach(touch => {
            showTouchEffect(touch.clientX, touch.clientY);
        });
        
        handleClick(e.touches.length > 1, e.touches.length);
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –º—ã—à—å—é
    clickImage.addEventListener('click', function(e) {
        if (e.touches) return;
        
        showTouchEffect(e.clientX, e.clientY);
        handleClick(false, 1);
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç –±–æ—Ç–∞
    tg.onEvent('webAppDataReceived', function(e) {
        console.log('üì• –î–∞–Ω–Ω—ã–µ –æ—Ç –±–æ—Ç–∞:', e);
        
        try {
            const data = JSON.parse(e.data);
            
            if (data.action === 'update_score') {
                currentScore = data.score;
                updateUI();
                statusEl.textContent = 'üü¢ –û–Ω–ª–∞–π–Ω';
                console.log('‚úÖ –°—á–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω:', currentScore);
            }
            else if (data.action === 'current_score') {
                currentScore = data.current_score || 0;
                bestScore = data.best_score || 0;
                totalClicks = data.total_clicks || 0;
                updateUI();
                statusEl.textContent = 'üü¢ –û–Ω–ª–∞–π–Ω';
                console.log('‚úÖ –¢–µ–∫—É—â–∏–π —Å—á–µ—Ç:', currentScore);
            }
            else if (data.action === 'leaderboard_data') {
                updateLeaderboardUI(data);
                console.log('‚úÖ –õ–∏–¥–µ—Ä–±–æ—Ä–¥ –æ–±–Ω–æ–≤–ª–µ–Ω');
            }
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –±–æ—Ç–∞:', error);
        }
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞
    function updateLeaderboardUI(data) {
        if (!data || !data.leaderboard) return;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ø 3
        const topPlayers = data.leaderboard.slice(0, 3);
        
        if (topPlayers[0]) {
            player1Name.textContent = topPlayers[0].name || '‚Äî';
            player1Score.textContent = topPlayers[0].score || 0;
        }
        
        if (topPlayers[1]) {
            player2Name.textContent = topPlayers[1].name || '‚Äî';
            player2Score.textContent = topPlayers[1].score || 0;
        }
        
        if (topPlayers[2]) {
            player3Name.textContent = topPlayers[2].name || '‚Äî';
            player3Score.textContent = topPlayers[2].score || 0;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (data.user_position !== undefined) {
            playerPositionEl.textContent = data.user_position || '‚Äî';
            
            if (data.user_position <= 3) {
                playerPositionEl.className = 'current-rank';
            }
        }
        
        if (data.user_data) {
            playerScoreEl.textContent = data.user_data.current_score || 0;
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    function init() {
        if (user) {
            console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', user);
        }
        
        clickImage.src = images[0];
        
        // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        getScoreFromServer();
        getLeaderboardFromServer();
        
        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        setInterval(getScoreFromServer, 30000); // –ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(getLeaderboardFromServer, 60000); // –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–∏–¥–µ—Ä–±–æ—Ä–¥ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
        setInterval(() => {
            getLeaderboardFromServer();
        }, 10000);
        
        console.log('üéÆ –ò–≥—Ä–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
    }

    // –ó–∞–ø—É—Å–∫
    init();
</script>